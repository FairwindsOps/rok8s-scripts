#!/bin/bash

if [ -n "${CONFIG_READ+1}" ]
then
  echo "Config already read"
  return 0
fi
echo "Reading config"
CONFIG_READ=1

while getopts ":f:" opt; do
  case $opt in
    f)
      CONFIG_FILE=$OPTARG
      ;;
    \?)
      echo "Invalid option: -$OPTARG" >&2
      exit 1
      ;;
  esac
done

BASEDIR=$(pwd)
DEPLOY_TIMEOUT=${DEPLOY_TIMEOUT:-300}
BLOCKING_JOB_TIMEOUT=${BLOCKING_JOB_TIMEOUT:-300}
ROK8S_ROLLBACK_DEPLOYMENTS=${ROK8S_ROLLBACK_DEPLOYMENTS:-no}

CONFIG=${CONFIG_FILE:-deploy/k8s-scripts.config}
if test -f $BASEDIR/$CONFIG ; then
  echo "Loading configuration from ${BASEDIR}/$CONFIG"
  . $BASEDIR/$CONFIG
else
  echo "Config file, ${BASEDIR}/$CONFIG, not found." >&2
  exit 1
fi

echo "[dockerfile]: $DOCKERFILE"
echo "[dockertag]: $DOCKERTAG"

echo "[external_registry_base_domain]: $EXTERNAL_REGISTRY_BASE_DOMAIN"

NAMESPACE=${NAMESPACE:=default}
echo "[namespace]: $NAMESPACE"

function expand_files() {
  local INPUT_NAME="${1}"
  local OUTPUT_NAME="${2}"
  local FILE_ENDING="${3}"

  local INPUTS=""
  eval "INPUTS=\${${INPUT_NAME}[@]}"

  if [[ ${#INPUTS} -eq 0 ]]; then
    return
  fi

  eval echo "[${INPUT_NAME}]: \${${INPUT_NAME}[@]}"

  for i in ${INPUTS}
  do
    filename="$BASEDIR/deploy/$i.${FILE_ENDING}"
    if [[ -f "${filename}" ]]; then
      eval "$OUTPUT_NAME+=("${filename}")"
    elif [[ -z "${ROK8S_ENABLE_OPTIONAL_CONFIGS}" ]]; then
      echo "ERROR: Missing ${filename}"
      exit 1
    else
      echo "INFO: Skipping optional ${filename}"
    fi
  done

  eval echo "[${OUTPUT_NAME}]: \${${OUTPUT_NAME}[@]}"
}

CONFIGMAP_FILES=()
expand_files "CONFIGMAPS" "CONFIGMAP_FILES" "configmap.yml"

SECRET_FILES=()
expand_files "SECRETS" "SECRET_FILES" "secret.yml"

EXTERNAL_SECRET_FILES=()
expand_files "EXTERNAL_SECRETS" "EXTERNAL_SECRET_FILES" "secret.external"

SOPS_SECRET_FILES=()
expand_files "SOPS_SECRETS" "SOPS_SECRET_FILES" "secret.sops.yml"

PERSISTENT_VOLUME_FILES=()
expand_files "PERSISTENT_VOLUMES" "PERSISTENT_VOLUME_FILES" "persistent_volume.yml"

PERSISTENT_VOLUME_CLAIM_FILES=()
expand_files "PERSISTENT_VOLUME_CLAIMS" "PERSISTENT_VOLUME_CLAIM_FILES" "persistent_volume_claim.yml"

STATEFULSET_FILES=()
expand_files "STATEFULSETS" "STATEFULSET_FILES" "statefulset.yml"

SERVICE_FILES=()
expand_files "SERVICES" "SERVICE_FILES" "service.yml"

ENDPOINT_FILES=()
expand_files "ENDPOINTS" "ENDPOINT_FILES" "endpoint.yml"

INGRESS_FILES=()
expand_files "INGRESSES" "INGRESS_FILES" "ingress.yml"

JOBS_FILES=()
expand_files "JOBS" "JOBS_FILES" "job.yml"

DEPLOYMENT_FILES=()
expand_files "DEPLOYMENTS" "DEPLOYMENT_FILES" "deployment.yml"

HORIZONTAL_POD_AUTOSCALER_FILES=()
expand_files "HORIZONTAL_POD_AUTOSCALERS" "HORIZONTAL_POD_AUTOSCALER_FILES" "horizontal_pod_autoscaler.yml"

POD_DISRUPTION_BUDGET_FILES=()
expand_files "POD_DISRUPTION_BUDGETS" "POD_DISRUPTION_BUDGET_FILES" "pod_disruption_budget.yml"

BLOCKING_JOBS_FILES=()
expand_files "BLOCKING_JOBS" "BLOCKING_JOBS_FILES" "blockingjob.yml"

CRONJOB_FILES=()
expand_files "CRONJOBS" "CRONJOB_FILES" "cronjob.yml"

CLUSTER_NAME=${CLUSTER_NAME}
echo "[cluster_name]: $CLUSTER_NAME"
echo ""

# Validate we have a sops key if need it
if [[ -n "${SOPS_SECRET_FILES}" ]]; then
  if [[ -n "${SOPS_KMS_ARN+x}" ]]; then
    SOPS_OPTIONS="--kms ${SOPS_KMS_ARN}"
  elif [[ -n "${SOPS_GCP_KMS_ID+x}" ]]; then
    SOPS_OPTIONS="--gcp-kms ${SOPS_GCP_KMS_ID}"
  else
    echo SOPS_KMS_ARN or SOPS_GCP_KMS_ID must bet set to use SOPS_SECRET_FILES!
    exit 1
  fi
fi
