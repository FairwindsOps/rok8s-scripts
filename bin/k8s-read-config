#!/bin/bash

if [ -n "${CONFIG_READ+1}" ]
then
  echo "Config already read"
  return 0
fi
echo "Reading config"
CONFIG_READ=1

while getopts ":f:" opt; do
  case $opt in
    f)
      CONFIG_FILE=$OPTARG
      ;;
    \?)
      echo "Invalid option: -$OPTARG" >&2
      exit 1
      ;;
  esac
done

BASEDIR=$(pwd)
DEPLOY_TIMEOUT=${DEPLOY_TIMEOUT:-300}
BLOCKING_JOB_TIMEOUT=${BLOCKING_JOB_TIMEOUT:-300}

CONFIG=${CONFIG_FILE:-deploy/k8s-scripts.config}
if test -f $BASEDIR/$CONFIG ; then
  echo "Loading configuration from ${BASEDIR}/$CONFIG"
  . $BASEDIR/$CONFIG
else
  echo "Config file, ${BASEDIR}/$CONFIG, not found." >&2
  exit 1
fi

echo "[dockerfile]: $DOCKERFILE"
echo "[dockertag]: $DOCKERTAG"

echo "[external_registry_base_domain]: $EXTERNAL_REGISTRY_BASE_DOMAIN"

NAMESPACE=${NAMESPACE:=default}
echo "[namespace]: $NAMESPACE"

echo "[configmaps]: ${CONFIGMAPS[@]}"
CONFIGMAP_FILES=()
for i in "${CONFIGMAPS[@]}"
do
  if [[ -f "$BASEDIR/deploy/$i.configmap.yml" ]]; then
    CONFIGMAP_FILES+=($BASEDIR/deploy/$i.configmap.yml)
  fi
done
echo "[configmap_files]: ${CONFIGMAP_FILES[@]}"

echo "[secrets]: ${SECRETS[@]}"
SECRET_FILES=()
for i in "${SECRETS[@]}"
do
  if [[ -f "$BASEDIR/deploy/$i.secret.yml" ]]; then
    SECRET_FILES+=($BASEDIR/deploy/$i.secret.yml)]
  fi
done
echo "[secret_files]: ${SECRET_FILES[@]}"

echo "[s3-secrets]: ${S3_SECRETS[@]}"

echo "[sops-secrets]: ${SOPS_SECRETS[@]}"
SOPS_SECRET_FILES=()
for i in "${SOPS_SECRETS[@]}"
do
  if [[ -f "$BASEDIR/deploy/$i.secret.sops.yml" ]]; then
    SOPS_SECRET_FILES+=($BASEDIR/deploy/$i.secret.sops.yml)
  fi
done
echo "[sops_secret_files]: ${SOPS_SECRET_FILES[@]}"

echo "[persistent volumes]: ${PERSISTENT_VOLUMES[@]}"
PERSISTENT_VOLUME_FILES=()
for i in "${PERSISTENT_VOLUMES[@]}"
do
  if [[ -f "$BASEDIR/deploy/$i.persistent_volume.yml" ]]; then
    PERSISTENT_VOLUME_FILES+=($BASEDIR/deploy/$i.persistent_volume.yml)
  fi
done
echo "[persistent_volume_files]: ${PERSISTENT_VOLUME_FILES[@]}"

echo "[persistent volume_claims]: ${PERSISTENT_VOLUME_CLAIMS[@]}"
PERSISTENT_VOLUME_CLAIM_FILES=()
for i in "${PERSISTENT_VOLUME_CLAIMS[@]}"
do
  if [[ -f "$BASEDIR/deploy/$i.persistent_volume_claim.yml" ]]; then
    PERSISTENT_VOLUME_CLAIM_FILES+=($BASEDIR/deploy/$i.persistent_volume_claim.yml)
  fi
done
echo "[persistent_volume_claim_files]: ${PERSISTENT_VOLUME_CLAIM_FILES[@]}"

echo "[statefulsets]: ${STATEFULSETS[@]}"
STATEFULSET_FILES=()
for i in "${STATEFULSETS[@]}"
do
  if [[ -f "$BASEDIR/deploy/$i.statefulset.yml" ]]; then
    STATEFULSET_FILES+=($BASEDIR/deploy/$i.statefulset.yml)
  fi
done
echo "[statefulset_files]: ${STATEFULSET_FILES[@]}"

echo "[services]: ${SERVICES[@]}"
SERVICE_FILES=()
for i in "${SERVICES[@]}"
do
  if [[ -f "$BASEDIR/deploy/$i.service.yml" ]]; then
    SERVICE_FILES+=($BASEDIR/deploy/$i.service.yml)
  fi
done
echo "[service_files]: ${SERVICE_FILES[@]}"

echo "[endpoints]: ${ENDPOINTS[@]}"
ENDPOINT_FILES=()
for i in "${ENDPOINTS[@]}"
do
  if [[ -f "$BASEDIR/deploy/$i.endpoint.yml" ]]; then
    ENDPOINT_FILES+=($BASEDIR/deploy/$i.endpoint.yml)
  fi
done
echo "[endpoint_files]: ${ENDPOINT_FILES[@]}"

echo "[ingresses]: ${INGRESSES[@]}"
INGRESS_FILES=()
for i in "${INGRESSES[@]}"
do
  if [[ -f "$BASEDIR/deploy/$i.ingress.yml" ]]; then
    INGRESS_FILES+=($BASEDIR/deploy/$i.ingress.yml)
  fi
done
echo "[ingress_files]: ${INGRESS_FILES[@]}"

echo "[jobs]: ${JOBS[@]}"
JOBS_FILES=()
for i in "${JOBS[@]}"
do
  if [[ -f "$BASEDIR/deploy/$i.job.yml" ]]; then
    JOBS_FILES+=($BASEDIR/deploy/$i.job.yml)
  fi
done
echo "[jobs_files]: ${JOBS_FILES[@]}"

echo "[deployments]: ${DEPLOYMENTS[@]}"
DEPLOYMENT_FILES=()
for i in "${DEPLOYMENTS[@]}"
do
  if [[ -f "$BASEDIR/deploy/$i.deployment.yml" ]]; then
    DEPLOYMENT_FILES+=($BASEDIR/deploy/$i.deployment.yml)
  fi
done
echo "[deployment_files]: ${DEPLOYMENT_FILES[@]}"

echo "[horizontal_pod_autoscalers]: ${HORIZONTAL_POD_AUTOSCALERS[@]}"
HORIZONTAL_POD_AUTOSCALER_FILES=()
for i in "${HORIZONTAL_POD_AUTOSCALERS[@]}"
do
  if [[ -f "$BASEDIR/deploy/$i.horizontal_pod_autoscaler.yml" ]]; then
    HORIZONTAL_POD_AUTOSCALER_FILES+=($BASEDIR/deploy/$i.horizontal_pod_autoscaler.yml)
  fi
done
echo "[horizontal_pod_autoscaler_files]: ${HORIZONTAL_POD_AUTOSCALER_FILES[@]}"

echo "[pod_disruption_budget]: ${POD_DISRUPTION_BUDGETS[@]}"
POD_DISRUPTION_BUDGET_FILES=()
for i in "${POD_DISRUPTION_BUDGETS[@]}"
do
  if [[ -f "$BASEDIR/deploy/$i.pod_disruption_budget.yml" ]]; then
     POD_DISRUPTION_BUDGET_FILES+=($BASEDIR/deploy/$i.pod_disruption_budget.yml)
  fi
done
echo "[pod_disruption_budget_files]: ${POD_DISRUPTION_BUDGET_FILES[@]}"

echo "[blocking jobs]: ${BLOCKING_JOBS[@]}"
BLOCKING_JOBS_FILES=()
for i in "${BLOCKING_JOBS[@]}"
do
  if [[ -f "$BASEDIR/deploy/$i.blockingjob.yml" ]]; then
    BLOCKING_JOBS_FILES+=($BASEDIR/deploy/$i.blockingjob.yml)
  fi
done
echo "[blocking_jobs_files]: ${BLOCKING_JOBS_FILES[@]}"

CLUSTER_NAME=${CLUSTER_NAME}
echo "[cluster_name]: $CLUSTER_NAME"

echo ""


echo "[cronjobs]: ${CRONJOBS[@]}"
CRONJOB_FILES=()
for i in "${CRONJOBS[@]}"
do
  CRONJOB_FILES+=($BASEDIR/deploy/$i.cronjob.yml)
done
echo "[cronjobs_files]: ${CRONJOB_FILES[@]}"
echo ""
