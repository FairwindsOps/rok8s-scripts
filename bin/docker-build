#!/bin/bash

. k8s-read-config "$@"

if [ -z "$BASEDIR" ];    then echo BASEDIR must be set; exit 1; fi
if [ -z "$DOCKERTAG" ];  then echo DOCKERTAG must be set; exit 1; fi
if [ -z "$DOCKERFILE" ]; then echo DOCKERFILE must be set; exit 1; fi

echo "Building ${DOCKERTAG} from ${BASEDIR}/${DOCKERFILE}"
echo "Build args: ${BUILD_ARGS}"

if [[ -n "${BUILD_ARGS}" ]]; then
  BUILD_ARGS="--build-arg ${BUILD_ARGS}"
fi

# shellcheck disable=SC2086
docker build --rm=false -t "${DOCKERTAG}" -f "${BASEDIR}/${DOCKERFILE}" ${BUILD_ARGS+"$BUILD_ARGS"} "${BASEDIR}"

if [ $? -ne 0 ]
then
  echo "Docker build failed! Aborting"
  exit 1
fi
