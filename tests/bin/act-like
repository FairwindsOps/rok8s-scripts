#!/usr/bin/env bash
program="$1"; shift
base="${program##*/}"
logfile="${TESTDIR}/test.log"
actlog="${TESTDIR}/act.log"
cmd_hash=$(echo $@ | md5 | cut -d ' ' -f 1)


echo "Base: ${base} Program: ${program} Hash: ${cmd_hash}" >> logfile
echo "${CMD} $@" >> "${actlog}"

fixtures="${TESTDIR}/fixtures/$base/${cmd_hash}"

mkdir -p "$fixtures"
echo "$@" > "$fixtures/command"

if [[ ! -d "$fixtures" ]]; then
  echo "Fixture does not exist ${fixtures}. Create stdout, stderr, and exit_code" >> logfile
  mkdir -p "$fixtures"
  echo "$@" > "$fixtures/command"
  # $program "$@" >"$fixtures/stdout" 2>"$fixtures/stderr"
  # echo $? > "$fixtures/exit_code"
  exit 1
fi

cat "$fixtures/stdout"
cat "$fixtures/stderr" >&2

read -r exit_code < "$fixtures/exit_code"

exit $exit_code
